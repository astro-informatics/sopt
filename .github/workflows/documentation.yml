name: Documentation

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]
    if: github.event.pull_request.draft == false
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

env:
  OMP_NUM_THREADS: 2

jobs:
  make-documentation:
    runs-on: ubuntu-22.04
    container: fedora:39
    steps:
      - name: Check out sopt
        uses: actions/checkout@v3

      # Enable tmate debugging of manually-triggered workflows if the input option was provided
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled }}

      - name: Install dependencies
        run: |
          sudo dnf -y update
          sudo dnf -y install cmake gcc gcc-c++
          sudo dnf -y install openmpi openmpi-devel yaml-cpp doxygen graphviz ccache eigen3-devel libtiff-devel catch2-devel

      #- name: Checkout Catch2
      #  uses: actions/checkout@v4
      #  with:
      #    repository: catchorg/Catch2.git
      #    path: Catch2
      #    ref: v3.4.0

      #- name: Build Catch2
      #  run: |
      #     mkdir Catch2/build
      #     cd Catch2/build
      #     cmake .. -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/local
      #     make -j$(nproc --ignore 1) install

      - name: Build
        run: |
          mkdir build && cd build
          cmake .. --fresh -DCMAKE_INSTALL_PREFIX=${PWD}/../local -Ddompi=OFF -Dopenmp=OFF -Ddocs=ON -Donnxrt=ON
          make -j$(nproc --ignore 1)
          make -j$(nproc --ignore 1) install

      - name: Make Docweb
        run: |
          cd build
          make docweb VERBOSE=1

      - name: Deploy to GH pages
        if: ${{github.event_name == 'push'}}
        uses: JamesIves/github-pages-deploy-action@4.1.6
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: build/cpp/docs/html # The folder the action should deploy.
